# 运行及测试手册

本文档说明如何在本地环境下运行 AiStock 的板块轮动示例工程，并执行自动化测试。

## 1. 环境要求

- Python 3.10 及以上版本（推荐使用 3.12）。
- 可以访问外网以获取实时数据。
- `pip` 可用（用于安装依赖）。
- 操作系统内置的 SQLite，Python 标准库已经自带，无需额外安装。

如果使用 `pyenv` 管理 Python，可执行：
```bash
pyenv install 3.12.5
pyenv local 3.12.5
```

## 2. 安装必需模块

运行日常分析需要安装 [AKShare](https://github.com/akfamily/akshare)；执行单元测试则需要安装 `pytest`。可一次性安装：
```bash
python -m pip install akshare pytest
```

> 如本地同时存在 Python2/Python3，可使用 `python3` / `pip3` 命令。

## 3. 运行板块轮动日常分析

日常分析入口位于 `ai_stock.run_daily_analysis`。以下示例使用 2024-09-20 作为样例日期，并将结果写入默认的 SQLite 文件 `sector_rotation_results.sqlite`。

```bash
PYTHONPATH=src python - <<'PY'
from datetime import date

from ai_stock import AnalysisConfig, run_daily_analysis

config = AnalysisConfig.daily_defaults(date(2024, 9, 20))
result = run_daily_analysis(config, db_path="sector_rotation_results.sqlite")

print(result["report"])
print("\nHeatmap:\n" + result["heatmap"])
PY
```

执行完成后，可使用 SQLite 客户端查看输出：
```bash
sqlite3 sector_rotation_results.sqlite "SELECT * FROM board_scores;"
```

若希望使用 JSON 保存结果，可显式指定 `.json` 文件路径：
```bash
PYTHONPATH=src python - <<'PY'
from datetime import date

from ai_stock import AnalysisConfig, run_daily_analysis

config = AnalysisConfig.daily_defaults(date(2024, 9, 20))
run_daily_analysis(config, db_path="sector_rotation_results.json")
PY
```

## 4. 执行自动化测试

确保已安装 pytest 后，运行：
```bash
PYTHONPATH=src python -m pytest
```

如使用特定 Python 版本，可指定绝对路径，例如：
```bash
PYTHONPATH=src ~/.pyenv/versions/3.12.5/bin/python -m pytest
```

## 5. 常见问题

- **找不到 `ai_stock` 包**：请确认已在项目根目录执行命令，并设置 `PYTHONPATH=src`（或将 `src` 添加到虚拟环境的 `PYTHONPATH` 中）。
- **缺少 pytest / akshare**：按“安装必需模块”章节安装后重试。
- **AKShare 请求失败**：检查网络连通性或目标接口是否正常，如需离线运行可读取 JSON/SQLite 中的历史输出。
- **权限或路径问题**：使用绝对路径或确保有写入权限的目录。

完成以上步骤即可顺利地在本地运行和验证该工程。
